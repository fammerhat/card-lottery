<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>11 æœˆè´¢ç¥èµç¦ç‹‚æ¬¢å­£</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff;
      padding: 16px 12px 32px;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    .app {
      position: relative;
      z-index: 1;
      max-width: 440px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 14px;
      padding-top: 4px;
    }
    .title {
      font-size: 22px;
      font-weight: 900;
      margin-bottom: 6px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.35);
      letter-spacing: 0.04em;
    }
    .subtitle {
      font-size: 13px;
      color: #cbd5e1;
      line-height: 1.4;
    }
    .guide-section {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      padding: 14px 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    .guide-title {
      font-size: 15px;
      font-weight: 800;
      color: #fbbf24;
      margin-bottom: 8px;
      text-align: center;
      letter-spacing: 0.05em;
    }
    .step {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: flex-start;
    }
    .step:last-child {
      margin-bottom: 0;
    }
    .step-number {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #0f172a;
      font-size: 16px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(251, 191, 36, 0.35);
    }
    .step-content {
      flex: 1;
      font-size: 12px;
      line-height: 1.45;
      color: #e2e8f0;
    }
    .step-content strong {
      color: #fbbf24;
      font-weight: 700;
    }
    .money {
      color: #fbbf24;
      font-weight: 800;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
    }
    .actions-wrapper {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.38);
    }
    .actions-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .btn {
      width: 100%;
      padding: 12px 6px;
      border-radius: 14px;
      border: none;
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
      text-decoration: none;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      transition: transform 0.15s, box-shadow 0.15s;
      cursor: pointer;
      min-height: 48px;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }
    .btn-primary {
      background: linear-gradient(135deg, #facc15, #fb923c);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #fff;
    }
    .btn-tertiary {
      background: linear-gradient(135deg, #1d4ed8, #4f46e5);
      color: #fff;
    }
    .emoji {
      font-size: 16px;
    }
    .gallery-section {
      margin-top: 6px;
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .gallery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #cbd5e1;
    }
    .gallery-track {
      height: 140px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      overflow: hidden;
      position: relative;
    }
    .gallery-track img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 14px;
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    .gallery-track img.active {
      opacity: 1;
    }
    .tip {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
      margin-top: 12px;
    }
    .dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 16px;
    }
    .dialog {
      width: 100%;
      max-width: 420px;
      background: #0f172a;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }
    .dialog-header {
      padding: 14px 16px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .dialog-title {
      font-size: 15px;
      font-weight: 700;
    }
    .dialog-close {
      background: none;
      border: none;
      color: #cbd5e1;
      font-size: 18px;
      cursor: pointer;
    }
    .dialog-body {
      padding: 10px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
      position: relative;
      order: 2;
    }
    .dialog-recommend {
      padding: 8px 16px 4px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.95);
      flex-shrink: 0;
      order: 3;
      position: relative;
      z-index: 5;
    }
    .recommend-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: #fbbf24;
      font-size: 12px;
      cursor: pointer;
      width: 33%;
      text-align: center;
      margin: 0 auto;
    }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-message {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .chat-message.user {
      align-self: flex-end;
      background: rgba(59, 130, 246, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }
    .chat-message .msg-label {
      font-weight: 700;
      font-size: 11px;
      color: #fbbf24;
    }
    .chat-message img {
      width: 100%;
      border-radius: 10px;
      object-fit: cover;
    }
    .chat-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chat-actions .btn {
      padding: 6px 10px;
      min-height: auto;
      border-radius: 10px;
      font-size: 11px;
    }
    .dialog-input {
      padding: 10px 16px 14px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      order: 4;
      flex-shrink: 0;
    }
    .upload-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #cbd5e1;
    }
    .dialog-input textarea {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(2, 6, 23, 0.8);
      color: #fff;
      padding: 10px 12px;
      font-size: 12px;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
      font-family: inherit;
      line-height: 1.5;
    }
    .dialog-input button.send {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      background: linear-gradient(135deg, #facc15, #fb923c);
      color: #0f172a;
      cursor: pointer;
    }
    .dialog-input button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .upload-preview {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    @media (max-width: 380px) {
      .actions-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .btn {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">11 æœˆè´¢ç¥èµç¦ç‹‚æ¬¢å­£ï¼</div>
      <div class="subtitle"><span class="money">3 å…ƒ</span>èµ·é¢†çº¢åŒ…ï¼Œ<span class="money">50 å…ƒ</span>å¤§é¢çº¢åŒ… + æœ€é«˜å¯å¾—<span class="money">100å…ƒ+</span></div>
    </div>

    <div class="guide-section">
      <div class="guide-title">æ´»åŠ¨é€Ÿé€šæŒ‡å—</div>
      <div class="step">
        <div class="step-number">â‘ </div>
        <div class="step-content">
          <strong>å…¥ç¾¤å³èµšï¼š</strong>ç‚¹å‡»ã€Œè´¢ç¥å¡æŠ½å–ã€ï¼Œè§£é”åˆå§‹è´¢ç¥å¡ï¼Œå†ç‚¹å‡»ã€Œä¸Šä¼ è´¢ç¥ã€æŒ‰è¦æ±‚ä¼ å›¾ï¼Œé¢†<span class="money">3å…ƒ</span>çº¢åŒ…ã€‚
        </div>
      </div>
      <div class="step">
        <div class="step-number">â‘¡</div>
        <div class="step-content">
          <strong>é‚€å‹å…±èµ¢ï¼š</strong>é‚€è¯·å…¬å¸å†…éƒ¨å‘˜å·¥å…¥ç¾¤ï¼Œç‚¹å‡»ã€Œé‚€è¯·å¥½å‹ç™»è®°ã€ï¼Œè‹¥å¥½å‹å®Œæˆä¼ å›¾ï¼Œä½ å¾—è´¢ç¥å¡ï¼Œæ¯è·ä¸€å¼ ä¸åŒçš„è´¢ç¥å¡å¹¶ä¸Šä¼ å¯¹åº”è´¢ç¥ç”Ÿæˆå›¾ï¼Œå¯å…‘ <span class="money">3 å…ƒ</span>çº¢åŒ…ï¼ˆå¥½å‹å·²å…¥å…¶ä»–æˆ˜é˜Ÿæ— æ•ˆï¼‰ã€‚
        </div>
      </div>
      <div class="step">
        <div class="step-number">â‘¢</div>
        <div class="step-content">
          <strong>é›†å¡åŠ ç ï¼š</strong>æ”’ 5 å¼ ä¸åŒè´¢ç¥å¡å¹¶ç”Ÿæˆè´¢ç¥å›¾ï¼Œç›´æ¥è§£é” <span class="money">50 å…ƒ</span>å¤§é¢çº¢åŒ…ã€‚
        </div>
      </div>
      <div class="step">
        <div class="step-number">â‘£</div>
        <div class="step-content">
          <strong>æˆ˜é˜Ÿ PKï¼š</strong>æœ€åä»¥æˆ˜é˜Ÿè´¢ç¥å¡æ€»é‡æ’åï¼ˆè‹¥åŒåçœ‹æŠ½å¡æ¬¡æ•°ï¼‰ï¼šæˆ˜é˜Ÿç¬¬ 1 åæ¯äºº <span class="money">30 å…ƒ</span>ã€ç¬¬ 2 å <span class="money">10 å…ƒ</span>ã€ç¬¬ 3 å <span class="money">5 å…ƒ</span>ï¼›è¿›æ­¥å¥–ï¼šè‹¥æ¯æ—¥æ’åå‰è¿› 1 åï¼Œç¾¤å†…æ¯äººå½“æ—¥å³å¯å¾— <span class="money">3 å…ƒ</span>ã€‚
        </div>
      </div>
    </div>

    <div class="actions-wrapper">
      <div class="actions-row">
        <a href="https://card-lottery.onrender.com/login" class="btn btn-primary">
          è´¢ç¥å¡æŠ½å–
        </a>
        <button class="btn btn-secondary" id="openGenerator">
          ç”Ÿæˆè´¢ç¥æ‰‹åŠ
        </button>
        <a href="https://v.wjx.cn/vm/OPVi0CD.aspx#" target="_blank" class="btn btn-tertiary">
          é‚€è¯·å¥½å‹ç™»è®°
        </a>
      </div>
      <div class="gallery-section" id="gallerySection">
        <div class="gallery-header">
          <span>ç©å®¶ç”Ÿæˆå±•ç¤º</span>
          <span style="font-size:11px;">3 ç§’è‡ªåŠ¨è½®æ’­</span>
        </div>
        <div class="gallery-track" id="galleryTrack"></div>
      </div>
    </div>

    <div class="tip">tipsï¼šæ¯æ—¥å®¡æ ¸1-2æ¬¡ï¼Œç»Ÿä¸€ä¸‹å‘çº¢åŒ…å’Œè´¢ç¥å¡æ¬¡æ•°</div>
  </div>

  <div class="dialog-overlay" id="generatorDialog">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title">ç”Ÿæˆè´¢ç¥æ‰‹åŠ</div>
        <button class="dialog-close" id="dialogClose">Ã—</button>
      </div>
      <div class="dialog-body">
        <div class="chat-area" id="chatMessages"></div>
      </div>
      <div class="dialog-recommend">
        <button class="recommend-btn" id="usePrompt">ä½¿ç”¨æ¨èå£ä»¤</button>
      </div>
      <div class="dialog-input">
        <label class="upload-btn" id="uploadTrigger">ğŸ–¼ï¸</label>
        <div class="upload-preview" id="uploadPreview" style="display:none;"></div>
        <input type="file" accept="image/*" id="uploadInput" hidden />
        <textarea id="promptInput" placeholder="è¾“å…¥ä½ çš„å£ä»¤æˆ–ä½¿ç”¨æ¨èå£ä»¤" rows="1"></textarea>
        <button class="send" id="sendBtn">ç”Ÿæˆ</button>
      </div>
    </div>
  </div>

  <script>
    const initialGallery = [
      {% for item in approved_images %}
      {
        "id": {{ item.id }},
        "thumbnail_url": {{ (item.thumbnail_url or "")|tojson }},
        "dream_image_url": {{ (item.dream_image_url or "")|tojson }},
        "user_name": {{ (item.user_name or "åŒ¿åç”¨æˆ·")|tojson }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
    const openGeneratorBtn = document.getElementById("openGenerator");
    const dialogOverlay = document.getElementById("generatorDialog");
    const dialogClose = document.getElementById("dialogClose");
    const usePromptBtn = document.getElementById("usePrompt");
    const uploadInput = document.getElementById("uploadInput");
    const uploadTrigger = document.getElementById("uploadTrigger");
    const uploadPreview = document.getElementById("uploadPreview");
    const promptInput = document.getElementById("promptInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatMessages = document.getElementById("chatMessages");
    const gallerySection = document.getElementById("gallerySection");
    const galleryTrack = document.getElementById("galleryTrack");

    const RECOMMENDED_PROMPT = "å¸®æˆ‘ç”Ÿæˆå›¾ç‰‡ï¼šç”¨è¿™å¼ å›¾ç‰‡çš„è„¸ç”Ÿæˆä¸€å¼ Qç‰ˆè´¢ç¥æ‰‹åŠï¼Œæè´¨ä¸ºï¼šé»åœŸæˆ–ç¾Šæ¯›æ¯¡æˆ–æ¯›çº¿ï¼Œéšæœºã€‚è´¢ç¥ç©¿æ±‰æœï¼Œæˆ´å¸½å­ï¼Œå¯ä»¥æœ‰èƒ¡å­ï¼Œå½¢è±¡å¯ä»¥å‚è€ƒäº”è·¯è´¢ç¥ï¼ˆæ¯”å¹²ã€æŸ´è£ã€å…³ç¾½ã€èµµå…¬æ˜ã€ç‹äº¥ï¼Œéšæœºï¼‰ã€‚æ•´ä½“æ˜¯å–œåº†é£æ ¼ï¼Œæš–è‰²è°ƒï¼ŒèƒŒæ™¯æœ‰ä¸€äº›æ–°å¹´å…ƒç´ ã€‚æœ‰ç«‹ä½“æ„Ÿï¼Œæœ‰å…‰æ³½åº¦ï¼Œæ‰‹åŠä¸ºå…¨èº«å®Œæ•´ï¼Œä¸”æœ‰åº•åº§ï¼Œæ‰‹åŠçš„è„¸éƒ¨ç‰¹å¾è¦å’ŒåŸå›¾çš„è„¸éƒ¨é«˜åº¦ç›¸ä¼¼ï¼Œæ€§åˆ«ç›¸åŒã€‚ä¸€å¼ æ­£æ–¹å½¢æ¯”ä¾‹å›¾ç‰‡ã€‚";

    let selectedFile = null;
    let galleryImages = [];
    let galleryIndex = 0;
    let galleryTimer = null;

    function openDialog() {
      dialogOverlay.style.display = "flex";
      document.body.style.overflow = "hidden";
      ensureChatPlaceholder();
      validateSendButton();
    }
    function closeDialog() {
      dialogOverlay.style.display = "none";
      document.body.style.overflow = "";
    }
    openGeneratorBtn.addEventListener("click", openDialog);
    dialogClose.addEventListener("click", closeDialog);
    dialogOverlay.addEventListener("click", (e) => {
      if (e.target === dialogOverlay) closeDialog();
    });

    function autoResizeTextarea() {
      promptInput.style.height = "auto";
      promptInput.style.height = Math.min(promptInput.scrollHeight, 120) + "px";
    }

    usePromptBtn.addEventListener("click", () => {
      promptInput.value = RECOMMENDED_PROMPT;
      autoResizeTextarea();
      validateSendButton();
    });

    uploadTrigger.addEventListener("click", () => uploadInput.click());
    uploadInput.addEventListener("change", () => {
      if (uploadInput.files && uploadInput.files[0]) {
        selectedFile = uploadInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadPreview.style.display = "block";
          uploadPreview.style.backgroundImage = `url(${e.target.result})`;
        };
        reader.readAsDataURL(selectedFile);
      }
      validateSendButton();
    });

    function validateSendButton() {
      // æŒ‰é’®å§‹ç»ˆå¯ç”¨ï¼Œç‚¹å‡»æ—¶ä¼šåœ¨ sendGenerate ä¸­æ£€æŸ¥å¹¶æ˜¾ç¤ºæç¤º
      // è¿™é‡Œå¯ä»¥æ·»åŠ è§†è§‰åé¦ˆï¼Œæ¯”å¦‚æ”¹å˜æŒ‰é’®æ ·å¼
      const hasImage = !!selectedFile;
      const hasPrompt = !!promptInput.value.trim();
      
      if (hasImage && hasPrompt) {
        sendBtn.style.opacity = "1";
        sendBtn.style.cursor = "pointer";
      } else {
        sendBtn.style.opacity = "0.6";
        sendBtn.style.cursor = "pointer";
      }
    }
    promptInput.addEventListener("input", () => {
      autoResizeTextarea();
      validateSendButton();
    });

    function appendMessage({ type, label, text, imageUrl, actions }) {
      const msg = document.createElement("div");
      msg.className = `chat-message ${type}`;
      if (label) {
        const lbl = document.createElement("div");
        lbl.className = "msg-label";
        lbl.textContent = label;
        msg.appendChild(lbl);
      }
      if (text) {
        const p = document.createElement("div");
        p.textContent = text;
        msg.appendChild(p);
      }
      if (imageUrl) {
        const img = document.createElement("img");
        img.src = imageUrl;
        msg.appendChild(img);
      }
      if (actions && actions.length) {
        const actionWrap = document.createElement("div");
        actionWrap.className = "chat-actions";
        actions.forEach((act) => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = act.label;
          btn.addEventListener("click", act.onClick);
          actionWrap.appendChild(btn);
        });
        msg.appendChild(actionWrap);
      }
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return msg;
    }

    function startProgress(messageEl) {
      const steps = [
        { value: 30, delay: 500 },
        { value: 60, delay: 800 },
        { value: 85, delay: 700 },
        { value: 95, delay: 500 },
      ];
      let timer = null;
      let index = 0;

      function run() {
        if (index >= steps.length) return;
        const step = steps[index];
        messageEl.textContent = `ç”Ÿæˆä¸­â€¦ ${step.value}%`;
        index += 1;
        timer = setTimeout(run, step.delay);
      }
      run();

      return {
        finish(success = true) {
          if (timer) clearTimeout(timer);
          messageEl.textContent = success ? "ç”Ÿæˆå®Œæˆï¼" : "ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        },
      };
    }

    function ensureChatPlaceholder() {
      if (!chatMessages.querySelector(".placeholder")) {
        const placeholder = document.createElement("div");
        placeholder.className = "chat-message placeholder";
        placeholder.textContent = "ä¸Šä¼ ä½ çš„å›¾ç‰‡ï¼Œå¼€å§‹ç”Ÿæˆä½ çš„è´¢ç¥å½¢è±¡å§";
        chatMessages.appendChild(placeholder);
      }
    }

    function clearPlaceholder() {
      const placeholder = chatMessages.querySelector(".placeholder");
      if (placeholder) placeholder.remove();
    }

    ensureChatPlaceholder();
    validateSendButton(); // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€

    async function sendGenerate(isRetry = false) {
      // æ£€æŸ¥æ˜¯å¦åŒæ—¶æœ‰å›¾ç‰‡å’Œæ–‡å­—å£ä»¤
      const hasImage = !!selectedFile;
      const hasPrompt = !!promptInput.value.trim();
      
      if (!hasImage && !hasPrompt) {
        appendMessage({
          type: "system",
          label: "æç¤º",
          text: "ä¸Šä¼ å‚è€ƒå›¾æ‰èƒ½ç”Ÿæˆå“¦",
        });
        return;
      }
      
      if (!hasImage) {
        appendMessage({
          type: "system",
          label: "æç¤º",
          text: "ä¸Šä¼ å‚è€ƒå›¾æ‰èƒ½ç”Ÿæˆå“¦",
        });
        return;
      }
      
      if (!hasPrompt) {
        appendMessage({
          type: "system",
          label: "æç¤º",
          text: "è¾“å…¥å£ä»¤æç¤ºè¯æ‰èƒ½ç”Ÿæˆå“¦",
        });
        return;
      }
      
      // å¼€å§‹ç”Ÿæˆæ—¶æš‚æ—¶ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      sendBtn.disabled = true;
      sendBtn.style.opacity = "0.6";
      sendBtn.style.cursor = "not-allowed";

      clearPlaceholder();

      let previewUrl = uploadPreview.style.backgroundImage || "";
      if (previewUrl.startsWith("url(")) {
        previewUrl = previewUrl.replace(/^url\(["']?/, "").replace(/["']?\)$/, "");
      } else {
        previewUrl = "";
      }

      appendMessage({
        type: "user",
        label: isRetry ? "é‡æ–°ç”Ÿæˆ" : "æˆ‘çš„å£ä»¤",
        text: promptInput.value.trim(),
        imageUrl: previewUrl || null,
      });

      const statusMsg = appendMessage({
        type: "system",
        label: "ç³»ç»Ÿ",
        text: "ç”Ÿæˆä¸­â€¦ 0%",
      });
      const progress = startProgress(statusMsg);

      const formData = new FormData();
      formData.append("prompt", promptInput.value.trim());
      formData.append("image", selectedFile);

      try {
        const resp = await fetch("/api/generate-figure", {
          method: "POST",
          body: formData,
        });
        const data = await resp.json();
        if (!resp.ok || !data.success) {
          progress.finish(false);
          appendMessage({
            type: "system",
            label: "æç¤º",
            text: data.message || "ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚",
          });
        } else {
          progress.finish(true);
          const resultMsg = appendMessage({
            type: "ai",
            label: "è´¢ç¥åŠ©æ‰‹",
            text: "è¿™æ˜¯ä½ çš„è´¢ç¥æ‰‹åŠï¼Œç‚¹å‡»ä¸‹æ–¹ä¸‹è½½æŒ‰é’®ï¼Œå»ç¾¤é‡Œåˆ†äº«å§ï¼",
            imageUrl: data.thumbnail_url,
            actions: [
              {
                label: "ä¸‹è½½å›¾ç‰‡",
                onClick: () => {
                  const link = document.createElement("a");
                  link.href = data.dream_image_url;
                  link.target = "_blank";
                  link.click();
                },
              },
              {
                label: "é‡æ–°ç”Ÿæˆ",
                onClick: () => sendGenerate(true),
              },
            ],
          });
          // æ¸…ç©ºè¾“å…¥å’Œå›¾ç‰‡
          promptInput.value = "";
          selectedFile = null;
          uploadPreview.style.display = "none";
          uploadInput.value = "";
          autoResizeTextarea();
          validateSendButton();
          // æ»šåŠ¨åˆ°ç”Ÿæˆç»“æœ
          setTimeout(() => {
            resultMsg.scrollIntoView({ behavior: "smooth", block: "end" });
          }, 100);
        }
      } catch (error) {
        console.error(error);
        progress.finish(false);
        appendMessage({
          type: "system",
          label: "æç¤º",
          text: "ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚",
        });
      } finally {
        validateSendButton(); // æ¢å¤æŒ‰é’®çŠ¶æ€
      }
    }

    sendBtn.addEventListener("click", () => sendGenerate(false));

    function renderGallery(images) {
      galleryTrack.innerHTML = "";
      if (!images.length) {
        gallerySection.style.display = "none";
        return;
      }
      gallerySection.style.display = "flex";
      images.forEach((img, idx) => {
        const node = document.createElement("img");
        node.src = img.thumbnail_url;
        if (idx === 0) node.classList.add("active");
        galleryTrack.appendChild(node);
      });
      galleryImages = Array.from(galleryTrack.querySelectorAll("img"));
      galleryIndex = 0;
      if (galleryTimer) clearInterval(galleryTimer);
      if (galleryImages.length > 1) {
        galleryTimer = setInterval(() => {
          galleryImages[galleryIndex].classList.remove("active");
          galleryIndex = (galleryIndex + 1) % galleryImages.length;
          galleryImages[galleryIndex].classList.add("active");
        }, 3000);
      }
    }

    async function loadApprovedImages() {
      try {
        const resp = await fetch("/api/approved-generates?limit=6");
        const data = await resp.json();
        if (data.success) {
          renderGallery(data.items || []);
        }
      } catch (error) {
        console.error("load gallery error", error);
      }
    }

    if (initialGallery.length) {
      renderGallery(initialGallery);
    }
    loadApprovedImages();
  </script>
</body>
</html>