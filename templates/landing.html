<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>11 月财神赐福狂欢季</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff;
      padding: 16px 12px 32px;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    .app {
      position: relative;
      z-index: 1;
      max-width: 440px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-top: 10px;
      position: relative;
    }
    .login-status {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 12px;
      color: #cbd5e1;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .login-status .login-name {
      font-weight: 600;
      color: #fde68a;
    }
    .login-status.not-logged {
      color: #fbbf24;
      text-decoration: none;
    }
    .login-status.not-logged:hover {
      text-decoration: underline;
    }
    .logout-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #cbd5e1;
      text-decoration: none;
    }
    .logout-btn:hover {
      border-color: rgba(251, 191, 36, 0.7);
      color: #fde68a;
    }
    .login-status {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 12px;
      color: #cbd5e1;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .login-status.logged-in {
      color: #fbbf24;
    }
    .login-status .login-name {
      font-weight: 600;
    }
    .flash-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #10b981, #059669);
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      font-size: 14px;
      font-weight: 600;
      z-index: 100;
      animation: slideDown 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
      animation-fill-mode: both;
      max-width: 90%;
      text-align: center;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
    }
    .title {
      font-size: 22px;
      font-weight: 900;
      margin-bottom: 6px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.35);
      letter-spacing: 0.04em;
    }
    .subtitle {
      font-size: 13px;
      color: #cbd5e1;
      line-height: 1.4;
    }
    .guide-section {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      padding: 14px 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    .guide-title {
      font-size: 15px;
      font-weight: 800;
      color: #fbbf24;
      margin-bottom: 8px;
      text-align: center;
      letter-spacing: 0.05em;
    }
    .step {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: flex-start;
    }
    .step:last-child {
      margin-bottom: 0;
    }
    .step-number {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #0f172a;
      font-size: 16px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(251, 191, 36, 0.35);
    }
    .step-content {
      flex: 1;
      font-size: 12px;
      line-height: 1.45;
      color: #e2e8f0;
    }
    .step-content strong {
      color: #fbbf24;
      font-weight: 700;
    }
    .money {
      color: #fbbf24;
      font-weight: 800;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
    }
    .actions-wrapper {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.38);
    }
    .actions-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .btn {
      width: 100%;
      padding: 12px 6px;
      border-radius: 14px;
      border: none;
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
      text-decoration: none;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      transition: transform 0.15s, box-shadow 0.15s;
      cursor: pointer;
      min-height: 48px;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }
    .btn-primary {
      background: linear-gradient(135deg, #facc15, #fb923c);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #fff;
    }
    .btn-tertiary {
      background: linear-gradient(135deg, #1d4ed8, #4f46e5);
      color: #fff;
    }
    .emoji {
      font-size: 16px;
    }
    .gallery-section {
      margin-top: 6px;
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .gallery-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      font-size: 13px;
      color: #cbd5e1;
      font-weight: 600;
    }
    .gallery-track {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 8px;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      gap: 8px;
      min-height: 0;
    }
    .gallery-track img {
      flex: 1;
      aspect-ratio: 1 / 1;
      width: 100%;
      object-fit: cover;
      border-radius: 12px;
      opacity: 0.75;
      transition: transform 0.3s ease, opacity 0.3s ease;
      border: 1px solid transparent;
      box-shadow: 0 0 0 rgba(251, 191, 36, 0);
    }
    .gallery-track img.active {
      opacity: 1;
      transform: scale(1.02);
      border-color: rgba(251, 191, 36, 0.5);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    }
    .tip {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
      margin-top: 12px;
    }
    .tips-section {
      margin-top: 12px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .tips-note {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 18px;
      text-align: left;
      line-height: 1.6;
    }
    .tips-title {
      font-size: 14px;
      color: #fbbf24;
      font-weight: 700;
      margin-bottom: 8px;
      text-align: left;
    }
    .tips-section .tip-item {
      font-size: 11px;
      color: #cbd5e1;
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .tips-section .tip-item:last-child {
      margin-bottom: 0;
    }
    .dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 16px;
    }
    .dialog {
      width: 100%;
      max-width: 420px;
      background: #0f172a;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }
    .dialog-header {
      padding: 14px 16px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .dialog-title {
      font-size: 15px;
      font-weight: 700;
    }
    .dialog-close {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.6);
      border-radius: 50%;
      color: #fca5a5;
      font-size: 24px;
      font-weight: 700;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
    }
    .dialog-close:hover {
      background: rgba(239, 68, 68, 0.4);
      border-color: rgba(239, 68, 68, 0.8);
      color: #f87171;
      transform: scale(1.1);
    }
    .dialog-body {
      padding: 10px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
      position: relative;
      order: 2;
    }
    .dialog-recommend {
      padding: 8px 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.95);
      flex-shrink: 0;
      order: 3;
      position: relative;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .recommend-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: #fbbf24;
    }
    .quota-hint {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
    }
    .quota-hint.exceeded {
      color: #f87171;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      width: 33%;
      text-align: center;
      margin: 0 auto;
    }
    .progress-container {
      width: 100%;
      margin-top: 8px;
      position: relative;
    }
    .progress-bar {
      height: 24px;
      background: linear-gradient(90deg, #fbbf24, #fb923c);
      border-radius: 12px;
      transition: width 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 0%;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      color: #1e293b;
      font-weight: 600;
      white-space: nowrap;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .progress-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(30, 41, 59, 0.3);
      border-top-color: #1e293b;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-message {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .chat-message.placeholder {
      background: transparent;
      border: none;
      padding: 10px 0;
      text-align: center;
      color: #9ca3af;
    }
    .chat-message.user {
      align-self: flex-end;
      background: rgba(59, 130, 246, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }
    .chat-message .msg-label {
      font-weight: 700;
      font-size: 11px;
      color: #fbbf24;
    }
    .chat-message img {
      width: 100%;
      border-radius: 10px;
      object-fit: cover;
      -webkit-touch-callout: default;
      user-select: none;
    }
    .chat-message .save-hint {
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
      margin-top: 4px;
    }
    .chat-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chat-actions .btn {
      padding: 6px 10px;
      min-height: auto;
      border-radius: 10px;
      font-size: 11px;
    }
    .dialog-input {
      padding: 10px 16px 14px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      order: 4;
      flex-shrink: 0;
    }
    .upload-btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .upload-btn:hover {
      background: rgba(148, 163, 184, 0.15);
      border-color: rgba(248, 250, 252, 0.4);
    }
    .dialog-input textarea {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(2, 6, 23, 0.8);
      color: #fff;
      padding: 10px 12px;
      font-size: 12px;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
      font-family: inherit;
      line-height: 1.5;
    }
    .dialog-input button.send {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      background: linear-gradient(135deg, #facc15, #fb923c);
      color: #0f172a;
      cursor: pointer;
    }
    .dialog-input button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .upload-preview {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    @media (max-width: 380px) {
      .actions-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .btn {
        font-size: 12px;
      }
    }
  </style>
</head>
<body data-is-logged-in="{{ 'true' if is_logged_in else 'false' }}">
  <div class="app">
    {% if flash_messages %}
      {% for category, message in flash_messages %}
        {% if category == 'success' %}
        <div class="flash-message" id="flashMessage">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endif %}
    <div class="header">
      {% if is_logged_in %}
      <div class="login-status logged-in">
        <span class="login-name">{{ user_name }}</span>
        <a class="logout-btn" href="{{ url_for('user_logout') }}">退出登录</a>
      </div>
      {% else %}
      <a class="login-status not-logged" href="/login?next=/">未登录</a>
      {% endif %}
      <div class="title">11 月财神赐福狂欢季！</div>
      <div class="subtitle"><span class="money">3 元</span>起领红包，<span class="money">50 元</span>大额奖，多多参与可拿<span class="money">100元</span>以上红包</div>
    </div>

    <div class="guide-section">
      <div class="guide-title">活动速通指南</div>
      <div class="step">
        <div class="step-number">①</div>
        <div class="step-content">
          <strong>入群即赚：</strong>点击「财神卡抽取」，解锁初始财神卡，再点击「生成财神手办」，每收集到1张全新财神卡并生成，可得<span class="money">3元</span>红包。
        </div>
      </div>
      <div class="step">
        <div class="step-number">②</div>
        <div class="step-content">
          <strong>集卡加码：</strong>攒 5 张不同财神卡并生成，解锁 <span class="money">50 元</span>大额红包。
        </div>
      </div>
      <div class="step">
        <div class="step-number">③</div>
        <div class="step-content">
          <strong>邀友共赢：</strong>邀请公司内部员工入群，点击「邀请好友登记」，你的好友生成后，你得抽卡次数（好友已入其他战队无效）。
        </div>
      </div>
      <div class="step">
        <div class="step-number">④</div>
        <div class="step-content">
          <strong>战队 PK：</strong>以战队累计总财神卡数量进行排名，战队第 1 名瓜分<span class="money">1000元</span>、第 2 名 瓜分<span class="money">500元</span>、第 3 名 瓜分<span class="money">100元</span>，若每日排名对比前一日前进 1 名，当日群内每人可瓜分<span class="money">50元</span>。
        </div>
      </div>
    </div>

    <div class="actions-wrapper">
      <div class="actions-row">
        <a href="#" class="btn btn-primary" id="drawCardBtn">
          财神卡抽取
        </a>
        <button class="btn btn-secondary" id="openGenerator">
          生成财神手办
        </button>
        <a href="#" class="btn btn-tertiary" id="inviteFriendBtn">
          邀请好友登记
        </a>
      </div>
      <div class="gallery-section" id="gallerySection">
        <div class="gallery-header">大家生成的财神手办</div>
        <div class="gallery-track" id="galleryTrack"></div>
      </div>
    </div>

    <div class="tips-note">
      1. 本活动由用户运营组用 AI Coding 为蛋糕春节活动玩法内核做的模拟测试<br />
      2. 首次尝试 AI 搭建，体验不足请多多反馈指导
    </div>

    <div class="tips-section">
      <div class="tips-title">活动细则</div>
      <div class="tip-item">1、每日审核1-2次刷新财神卡次数，可以先邀请好友入群，积累一定次数再抽卡，效率更高</div>
      <div class="tip-item">2、登记的好友同时在多个群，不计算战队成绩内，请提前确认好友是否加入其他战队（抢人大战）</div>
      <div class="tip-item">3、入群后请将群昵称改为真实姓名</div>
      <div class="tip-item">4、每个人生成5次财神手办即可，无需重复生成财神</div>
      <div class="tip-item">5、活动截止时间11月24日17点，统计战队排名（财神卡总数）</div>
    </div>
  </div>

  <div class="dialog-overlay" id="generatorDialog">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title">生成财神手办</div>
        <button class="dialog-close" id="dialogClose">×</button>
      </div>
      <div class="dialog-body">
        <div class="chat-area" id="chatMessages"></div>
      </div>
      <div class="dialog-recommend">
        <button class="recommend-btn" id="usePrompt">使用推荐口令</button>
        <div class="quota-hint" id="quotaHint">每天有5次生成机会哦！</div>
      </div>
      <div class="dialog-input">
        <label class="upload-btn" id="uploadTrigger">上传图片</label>
        <div class="upload-preview" id="uploadPreview" style="display:none;"></div>
        <input type="file" accept="image/*" id="uploadInput" hidden />
        <textarea id="promptInput" placeholder="输入你的口令或使用推荐口令" rows="1"></textarea>
        <button class="send" id="sendBtn">生成</button>
      </div>
    </div>
  </div>

  <script type="application/json" id="initialGalleryData">{{ approved_gallery_data|tojson|safe }}</script>

  <script>
    /* eslint-disable */
    const initialGalleryEl = document.getElementById("initialGalleryData");
    const initialGallery = initialGalleryEl ? JSON.parse(initialGalleryEl.textContent || "[]") : [];
    const openGeneratorBtn = document.getElementById("openGenerator");
    const dialogOverlay = document.getElementById("generatorDialog");
    const dialogClose = document.getElementById("dialogClose");
    const usePromptBtn = document.getElementById("usePrompt");
    const uploadInput = document.getElementById("uploadInput");
    const uploadTrigger = document.getElementById("uploadTrigger");
    const uploadPreview = document.getElementById("uploadPreview");
    const promptInput = document.getElementById("promptInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatMessages = document.getElementById("chatMessages");
    const gallerySection = document.getElementById("gallerySection");
    const galleryTrack = document.getElementById("galleryTrack");
    const drawCardBtn = document.getElementById("drawCardBtn");
    const inviteFriendBtn = document.getElementById("inviteFriendBtn");
    const quotaHint = document.getElementById("quotaHint");

    // 登录状态（从后端传递）
    const isLoggedIn = document.body.dataset.isLoggedIn === "true";
    
    // 获取生成配额（仅用于检查是否用完，不显示动态次数）
    async function updateQuota() {
      if (!isLoggedIn) {
        quotaHint.textContent = "每天有5次生成机会哦！";
        return;
      }
      try {
        const resp = await fetch("/api/generate-quota");
        const data = await resp.json();
        if (data.success) {
          const remaining = data.remaining;
          if (remaining > 0) {
            quotaHint.textContent = "每天有5次生成机会哦！";
            quotaHint.className = "quota-hint";
          } else {
            quotaHint.textContent = "您今天的生成额度已用完，明天再来！";
            quotaHint.className = "quota-hint exceeded";
            sendBtn.disabled = true;
            sendBtn.style.opacity = "0.6";
            sendBtn.style.cursor = "not-allowed";
          }
        }
      } catch (error) {
        console.error("获取配额失败:", error);
        quotaHint.textContent = "每天有5次生成机会哦！";
      }
    }
    
    // 页面加载时获取配额
    if (isLoggedIn) {
      updateQuota();
    }

    const RECOMMENDED_PROMPT = "帮我生成图片：用这张图片的脸生成一张Q版财神手办，材质为：黏土或羊毛毡或毛线，随机。财神穿汉服，戴帽子，形象可以参考五路财神（比干、柴荣、关羽、赵公明、王亥，随机）。整体是喜庆风格，暖色调，背景有一些新年元素。有立体感，有光泽度，手办为全身完整，且有底座，手办的脸部特征要和原图的脸部高度相似，性别相同。一张正方形比例图片。";

    let selectedFile = null;
    let lastFile = null;
    let lastPrompt = "";
    let lastPreviewUrl = "";
    const GALLERY_VISIBLE_COUNT = 3;
    let galleryData = [];
    let gallerySlots = [];
    let galleryIndex = 0;
    let galleryTimer = null;
    let pendingUserMessage = null;
    let pendingUserMessageEl = null;

    // 检查登录状态，未登录则跳转到登录页
    function checkLoginAndRedirect(targetUrl, action) {
      if (!isLoggedIn) {
        // 未登录，跳转到登录页，并保存目标页面
        const loginUrl = `/login?next=${encodeURIComponent(targetUrl)}`;
        window.location.href = loginUrl;
        return false;
      }
      return true;
    }

    async function openDialog() {
      // 检查登录状态
      if (!checkLoginAndRedirect(window.location.href, "生成财神手办")) {
        return;
      }
      dialogOverlay.style.display = "flex";
      document.body.style.overflow = "hidden";
      
      await restoreChatHistory();
      if (!chatMessages.querySelector(".chat-message")) {
        ensureChatPlaceholder();
      } else {
        clearPlaceholder();
      }
      
      updateQuota().then(() => {
        validateSendButton();
      });
    }
    function resetChatMessagesView() {
      chatMessages.innerHTML = "";
      historyLoaded = false;
      pendingUserMessage = null;
      pendingUserMessageEl = null;
      ensureChatPlaceholder();
    }

    function closeDialog() {
      dialogOverlay.style.display = "none";
      document.body.style.overflow = "";
      resetChatMessagesView();
    }
    openGeneratorBtn.addEventListener("click", openDialog);
    
    // 财神卡抽取按钮
    drawCardBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const targetUrl = "/draw";
      if (checkLoginAndRedirect(targetUrl, "财神卡抽取")) {
        window.location.href = targetUrl;
      }
    });
    
    // 邀请好友登记按钮
    inviteFriendBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const targetUrl = "https://v.wjx.cn/vm/OPVi0CD.aspx#";
      if (checkLoginAndRedirect(targetUrl, "邀请好友登记")) {
        window.open(targetUrl, "_blank");
      }
    });
    dialogClose.addEventListener("click", closeDialog);
    dialogOverlay.addEventListener("click", (e) => {
      if (e.target === dialogOverlay) closeDialog();
    });

    function autoResizeTextarea() {
      promptInput.style.height = "auto";
      promptInput.style.height = Math.min(promptInput.scrollHeight, 120) + "px";
    }

    usePromptBtn.addEventListener("click", () => {
      promptInput.value = RECOMMENDED_PROMPT;
      autoResizeTextarea();
      validateSendButton();
    });

    uploadTrigger.addEventListener("click", () => uploadInput.click());
    uploadInput.addEventListener("change", () => {
      if (uploadInput.files && uploadInput.files[0]) {
        selectedFile = uploadInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadPreview.style.display = "block";
          uploadPreview.style.backgroundImage = `url(${e.target.result})`;
          lastPreviewUrl = e.target.result;
        };
        reader.readAsDataURL(selectedFile);
      }
      validateSendButton();
    });

    async function validateSendButton() {
      // 按钮始终可点击，不再根据输入状态禁用
      // 只在配额用完时禁用
      if (isLoggedIn && quotaHint) {
        const quotaHintText = quotaHint.textContent;
        const hasQuota = !quotaHintText.includes("已用完");
        if (!hasQuota) {
          sendBtn.disabled = true;
          sendBtn.style.opacity = "0.6";
          sendBtn.style.cursor = "not-allowed";
        } else {
          sendBtn.disabled = false;
          sendBtn.style.opacity = "1";
          sendBtn.style.cursor = "pointer";
        }
      } else {
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
        sendBtn.style.cursor = "pointer";
      }
    }
    promptInput.addEventListener("input", () => {
      autoResizeTextarea();
      validateSendButton();
    });

    const CHAT_IMAGE_MAX_LENGTH = 380000;
    let historyLoaded = false;

    async function restoreChatHistory() {
      if (!isLoggedIn || historyLoaded) return;
      try {
        const resp = await fetch("/api/chat-history");
        const data = await resp.json();
        if (data.success && Array.isArray(data.items)) {
          data.items.forEach((msgData) => {
            appendMessage(
              {
                type: msgData.type,
                label: msgData.label,
                text: msgData.text,
                imageUrl: msgData.image_url,
                showSaveHint: msgData.show_save_hint,
              },
              { persist: false }
            );
          });
          historyLoaded = true;
          if (data.items.length) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          } else {
            ensureChatPlaceholder();
          }
        }
      } catch (error) {
        console.error("恢复聊天记录失败:", error);
      }
    }

    async function persistChatMessage(message, options = {}) {
      if (!isLoggedIn) return;
      const allowBase64Image = options.allowBase64Image || false;
      const payload = {
        type: message.type,
        label: message.label || "",
        text: message.text || "",
        image_url: "",
        show_save_hint: !!message.showSaveHint,
      };

      if (message.imageUrl) {
        if (message.imageUrl.startsWith("data:")) {
          if (!allowBase64Image) {
            // 等待后端返回正式URL再保存
            return;
          }
          payload.image_url = message.imageUrl.slice(0, CHAT_IMAGE_MAX_LENGTH);
        } else {
          payload.image_url = message.imageUrl;
        }
      }

      if (!payload.text && !payload.image_url) {
        return;
      }

      try {
        await fetch("/api/chat-history", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
      } catch (error) {
        console.error("保存聊天记录失败:", error);
      }
    }

    function appendMessage({ type, label, text, imageUrl, actions, showSaveHint }, options = {}) {
      const persist = options.persist !== false;
      const allowBase64Image = !!options.allowBase64Image;
      const msg = document.createElement("div");
      msg.className = `chat-message ${type}`;
      if (label) {
        const lbl = document.createElement("div");
        lbl.className = "msg-label";
        lbl.textContent = label;
        msg.appendChild(lbl);
      }
      if (text) {
        const p = document.createElement("div");
        p.textContent = text;
        msg.appendChild(p);
      }
      if (imageUrl) {
        const img = document.createElement("img");
        img.src = imageUrl;
        msg.appendChild(img);
        if (showSaveHint) {
          const hint = document.createElement("div");
          hint.className = "save-hint";
          hint.textContent = "长按图片保存";
          msg.appendChild(hint);
        }
      }
      if (actions && actions.length) {
        const actionWrap = document.createElement("div");
        actionWrap.className = "chat-actions";
        actions.forEach((act) => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = act.label;
          btn.addEventListener("click", act.onClick);
          actionWrap.appendChild(btn);
        });
        msg.appendChild(actionWrap);
      }
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (persist && !msg.querySelector(".progress-container")) {
        persistChatMessage(
          {
            type,
            label,
            text,
            imageUrl,
            showSaveHint,
          },
          { allowBase64Image }
        );
      }
      
      return msg;
    }

    function updateMessageImage(messageEl, imageUrl) {
      if (!messageEl || !imageUrl) return;
      let img = messageEl.querySelector("img");
      if (!img) {
        img = document.createElement("img");
        messageEl.appendChild(img);
      }
      img.src = imageUrl;
    }

    function finalizePendingUserMessage(imageUrlFromServer = "", options = {}) {
      if (!pendingUserMessage) return;
      if (imageUrlFromServer) {
        pendingUserMessage.imageUrl = imageUrlFromServer;
        if (pendingUserMessageEl) {
          updateMessageImage(pendingUserMessageEl, imageUrlFromServer);
        }
      }
      const allowBase64Image =
        options.allowBase64Image ||
        (!imageUrlFromServer &&
          pendingUserMessage.imageUrl &&
          pendingUserMessage.imageUrl.startsWith("data:"));
      persistChatMessage(pendingUserMessage, {
        allowBase64Image,
      });
      pendingUserMessage = null;
      pendingUserMessageEl = null;
    }

    function startProgress(messageEl) {
      // 创建进度条容器
      const progressContainer = document.createElement("div");
      progressContainer.className = "progress-container";
      
      // 背景条（灰色背景，显示总进度）
      const progressBg = document.createElement("div");
      progressBg.style.cssText = "width: 100%; height: 24px; background: rgba(148, 163, 184, 0.2); border-radius: 12px; position: relative; overflow: hidden;";
      
      const progressBar = document.createElement("div");
      progressBar.className = "progress-bar";
      progressBar.style.width = "0%";
      
      const progressText = document.createElement("div");
      progressText.className = "progress-text";
      
      // 创建转圈圈动画
      const spinner = document.createElement("div");
      spinner.className = "progress-spinner";
      
      // 创建文本节点
      const textNode = document.createTextNode("生成进度0%，免费服务器速度慢，请耐心等待");
      
      progressText.appendChild(spinner);
      progressText.appendChild(textNode);
      
      progressBg.appendChild(progressBar);
      progressBg.appendChild(progressText);
      progressContainer.appendChild(progressBg);
      messageEl.innerHTML = "";
      messageEl.appendChild(progressContainer);
      
      // 确保进度条在视野内可见
      setTimeout(() => {
        progressContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }, 100);
      
      let currentProgress = 0;
      let timer = null;
      
      // 91%之前快速加载
      function fastProgress() {
        if (currentProgress >= 91) {
          slowProgress();
          return;
        }
        currentProgress += Math.random() * 15 + 5; // 5-20% 随机增长
        if (currentProgress > 91) currentProgress = 91;
        
        progressBar.style.width = currentProgress + "%";
        // 更新文本内容（保留转圈圈）
        const textNode = progressText.childNodes[1];
        if (textNode) {
          textNode.textContent = `生成进度${Math.floor(currentProgress)}%，免费服务器速度慢，请耐心等待`;
        }
        
        timer = setTimeout(fastProgress, 200 + Math.random() * 300); // 200-500ms随机延迟
      }
      
      // 91%之后缓慢增加到99%（最高99%）
      function slowProgress() {
        if (currentProgress >= 99) return;
        currentProgress += Math.random() * 2 + 0.5; // 0.5-2.5% 缓慢增长
        if (currentProgress > 99) currentProgress = 99;
        
        progressBar.style.width = currentProgress + "%";
        // 更新文本内容（保留转圈圈）
        const textNode = progressText.childNodes[1];
        if (textNode) {
          textNode.textContent = `生成进度${Math.floor(currentProgress)}%，免费服务器速度慢，请耐心等待`;
        }
        
        timer = setTimeout(slowProgress, 500 + Math.random() * 500); // 500-1000ms随机延迟
      }
      
      fastProgress();

      return {
        finish(success = true) {
          if (timer) clearTimeout(timer);
          if (success) {
            // 生成成功后，移除整个进度条消息
            if (messageEl && messageEl.parentNode) {
              messageEl.parentNode.removeChild(messageEl);
            }
          } else {
            // 失败时显示错误信息（移除转圈圈，只显示文本）
            const spinner = progressText.querySelector(".progress-spinner");
            if (spinner) {
              spinner.remove();
            }
            const textNode = progressText.childNodes[0];
            if (textNode) {
              textNode.textContent = "参与人过多，免费服务器带宽不足，麻烦重新加载试试";
            } else {
              progressText.textContent = "参与人过多，免费服务器带宽不足，麻烦重新加载试试";
            }
            progressBar.style.width = "100%";
            progressBar.style.background = "linear-gradient(90deg, #ef4444, #dc2626)";
          }
        },
      };
    }

    function ensureChatPlaceholder() {
      if (!chatMessages.querySelector(".placeholder")) {
        const placeholder = document.createElement("div");
        placeholder.className = "chat-message placeholder";
        placeholder.textContent = "上传你的图片，开始生成你的财神形象吧";
        chatMessages.appendChild(placeholder);
      }
    }

    function clearPlaceholder() {
      const placeholder = chatMessages.querySelector(".placeholder");
      if (placeholder) placeholder.remove();
    }

    function resetGenerateInputs() {
      selectedFile = null;
      uploadInput.value = "";
      uploadPreview.style.display = "none";
      uploadPreview.style.backgroundImage = "";
      promptInput.value = "";
      autoResizeTextarea();
      validateSendButton();
    }

    // 初始化时不显示placeholder，等打开对话框时再恢复历史记录
    validateSendButton(); // 初始化按钮状态

    function getCurrentPreviewUrl() {
      let previewUrl = uploadPreview.style.backgroundImage || "";
      if (previewUrl.startsWith("url(")) {
        previewUrl = previewUrl.replace(/^url\(["']?/, "").replace(/["']?\)$/, "");
      } else {
        previewUrl = "";
      }
      if (!previewUrl && lastPreviewUrl) {
        previewUrl = lastPreviewUrl;
      }
      return previewUrl;
    }

    async function sendGenerate(isRetry = false) {
      const promptText = promptInput.value.trim() || lastPrompt;
      const fileToUse = selectedFile || lastFile;
      
      // 检查输入，根据实际情况提示
      if (!fileToUse && !promptText) {
        appendMessage({
          type: "system",
          label: "提示",
          text: "请上传图片，并输入口令提示词",
        });
        return;
      }
      
      if (!fileToUse) {
        appendMessage({
          type: "system",
          label: "提示",
          text: "请上传图片",
        });
        return;
      }
      
      if (!promptText) {
        appendMessage({
          type: "system",
          label: "提示",
          text: "请输入口令提示词",
        });
        return;
      }
      
      // 开始生成时暂时禁用按钮，防止重复点击
      sendBtn.disabled = true;
      sendBtn.style.opacity = "0.6";
      sendBtn.style.cursor = "not-allowed";
      let progress = null;
      let statusMsg = null;
      let requestInFlight = false;

      try {
        clearPlaceholder();

        const previewUrl = getCurrentPreviewUrl();

        const userLabel = isRetry ? "重新生成" : "我的口令";
        const displayedImage = previewUrl || lastPreviewUrl || null;
        pendingUserMessage = {
          type: "user",
          label: userLabel,
          text: promptText,
          imageUrl: displayedImage || "",
        };
        pendingUserMessageEl = appendMessage(
          {
            type: "user",
            label: userLabel,
            text: promptText,
            imageUrl: displayedImage,
          },
          { persist: false }
        );

        statusMsg = appendMessage(
          {
          type: "system",
          label: "系统",
          text: "",
          },
          { persist: false }
        ); // 不保存进度条消息
        progress = startProgress(statusMsg);

        const formData = new FormData();
        formData.append("prompt", promptText);
        formData.append("image", fileToUse);

        // 创建AbortController用于超时控制
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
        }, 90000); // 90秒超时

        requestInFlight = true;
        try {
          const resp = await fetch("/api/generate-figure", {
            method: "POST",
            body: formData,
            signal: controller.signal,
          });
          
          clearTimeout(timeoutId);
          const data = await resp.json();
          
          if (!resp.ok || !data.success) {
            progress.finish(false);
            if (data.error === "QUOTA_EXCEEDED") {
              appendMessage({
                type: "system",
                label: "提示",
                text: data.message || "您今天的生成额度已用完，明天再来！",
              });
              updateQuota();
            } else {
              // 统一错误提示
              appendMessage({
                type: "system",
                label: "提示",
                text: data.message || "参与人过多，免费服务器带宽不足，麻烦重新加载试试",
              });
            }
            finalizePendingUserMessage(data.original_image_url || "", {
              allowBase64Image: !data.original_image_url,
            });
          } else {
            progress.finish(true);
            lastPrompt = promptText;
            lastFile = fileToUse;
            lastPreviewUrl = data.original_image_url || previewUrl;
            finalizePendingUserMessage(data.original_image_url || "");
            const resultMsg = appendMessage({
              type: "ai",
              label: "财神助手",
              text: "这是你的财神手办，长按图片保存！",
              imageUrl: data.dream_image_url || data.thumbnail_url,
              showSaveHint: true,
            });
            // 更新配额显示
            updateQuota();
            // 滚动到生成结果
            setTimeout(() => {
              resultMsg.scrollIntoView({ behavior: "smooth", block: "end" });
            }, 100);
          }
        } catch (error) {
          clearTimeout(timeoutId);
          console.error("生成请求失败:", error);
          if (progress) {
            progress.finish(false);
          }
          
          // 统一错误提示
          appendMessage({
            type: "system",
            label: "提示",
            text: "参与人过多，免费服务器带宽不足，麻烦重新加载试试",
          });
          finalizePendingUserMessage("", { allowBase64Image: true });
        } finally {
          requestInFlight = false;
          resetGenerateInputs();
          // 恢复按钮状态（配额检查）
          validateSendButton();
        }
      } catch (error) {
        console.error("生成流程出现异常:", error);
        if (progress) {
          progress.finish(false);
        } else if (statusMsg && statusMsg.parentNode) {
          statusMsg.parentNode.removeChild(statusMsg);
        }
        appendMessage({
          type: "system",
          label: "提示",
          text: "生成流程出现异常，请刷新后重试",
        });
        finalizePendingUserMessage("", { allowBase64Image: true });
        if (!requestInFlight) {
          // 如果请求尚未发出，手动恢复按钮状态（保留用户输入，便于再次尝试）
          sendBtn.disabled = false;
          sendBtn.style.opacity = "1";
          sendBtn.style.cursor = "pointer";
        }
      }
    }

    sendBtn.addEventListener("click", () => sendGenerate(false));

    function clearGalleryTimer() {
      if (galleryTimer) {
        clearInterval(galleryTimer);
        galleryTimer = null;
      }
    }

    function setupGallerySlots(count) {
      galleryTrack.innerHTML = "";
      for (let i = 0; i < count; i += 1) {
        const img = document.createElement("img");
        galleryTrack.appendChild(img);
      }
      gallerySlots = Array.from(galleryTrack.querySelectorAll("img"));
    }

    function updateGalleryDisplay() {
      if (!gallerySlots.length || !galleryData.length) return;
      const total = galleryData.length;
      gallerySlots.forEach((img, idx) => {
        const dataIndex = (galleryIndex + idx) % total;
        const item = galleryData[dataIndex];
        img.src = item.thumbnail_url;
        img.alt = item.prompt || "生成结果";
        img.classList.toggle("active", idx === 0);
      });
    }

    function renderGallery(images) {
      galleryData = images.slice();
      if (!galleryData.length) {
        gallerySection.style.display = "none";
        clearGalleryTimer();
        return;
      }
      gallerySection.style.display = "flex";
      const visibleCount = Math.min(GALLERY_VISIBLE_COUNT, galleryData.length);
      setupGallerySlots(visibleCount);
      galleryIndex = 0;
      updateGalleryDisplay();
      clearGalleryTimer();
      if (galleryData.length > visibleCount) {
        galleryTimer = setInterval(() => {
          galleryIndex = (galleryIndex + 1) % galleryData.length;
          updateGalleryDisplay();
        }, 3000);
      }
    }

    async function loadApprovedImages() {
      try {
        const resp = await fetch("/api/approved-generates?limit=3");
        const data = await resp.json();
        if (data.success && data.items && data.items.length > 0) {
          renderGallery(data.items);
        } else {
          gallerySection.style.display = "none";
        }
      } catch (error) {
        console.error("load gallery error", error);
        gallerySection.style.display = "none";
      }
    }

    if (initialGallery.length) {
      renderGallery(initialGallery);
    } else {
      loadApprovedImages();
    }
    // 自动隐藏登录成功提示
    const flashMessage = document.getElementById("flashMessage");
    if (flashMessage) {
      setTimeout(() => {
        flashMessage.style.display = "none";
      }, 3000); // 3秒后隐藏
    }
  </script>
</body>
</html>