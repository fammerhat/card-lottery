<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>11 月财神赐福狂欢季</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff;
      padding: 16px 12px 32px;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    .app {
      position: relative;
      z-index: 1;
      max-width: 440px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 14px;
      padding-top: 4px;
      position: relative;
    }
    .login-status {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 12px;
      color: #cbd5e1;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .login-status.logged-in {
      color: #fbbf24;
    }
    .login-status .login-name {
      font-weight: 600;
    }
    .title {
      font-size: 22px;
      font-weight: 900;
      margin-bottom: 6px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.35);
      letter-spacing: 0.04em;
    }
    .subtitle {
      font-size: 13px;
      color: #cbd5e1;
      line-height: 1.4;
    }
    .guide-section {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      padding: 14px 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    .guide-title {
      font-size: 15px;
      font-weight: 800;
      color: #fbbf24;
      margin-bottom: 8px;
      text-align: center;
      letter-spacing: 0.05em;
    }
    .step {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: flex-start;
    }
    .step:last-child {
      margin-bottom: 0;
    }
    .step-number {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #0f172a;
      font-size: 16px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(251, 191, 36, 0.35);
    }
    .step-content {
      flex: 1;
      font-size: 12px;
      line-height: 1.45;
      color: #e2e8f0;
    }
    .step-content strong {
      color: #fbbf24;
      font-weight: 700;
    }
    .money {
      color: #fbbf24;
      font-weight: 800;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
    }
    .actions-wrapper {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.38);
    }
    .actions-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .btn {
      width: 100%;
      padding: 12px 6px;
      border-radius: 14px;
      border: none;
      font-size: 13px;
      font-weight: 700;
      color: #0f172a;
      text-decoration: none;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      transition: transform 0.15s, box-shadow 0.15s;
      cursor: pointer;
      min-height: 48px;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }
    .btn-primary {
      background: linear-gradient(135deg, #facc15, #fb923c);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #fff;
    }
    .btn-tertiary {
      background: linear-gradient(135deg, #1d4ed8, #4f46e5);
      color: #fff;
    }
    .emoji {
      font-size: 16px;
    }
    .gallery-section {
      margin-top: 6px;
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    .gallery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #cbd5e1;
    }
    .gallery-track {
      height: 140px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      overflow: hidden;
      position: relative;
    }
    .gallery-track img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 14px;
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    .gallery-track img.active {
      opacity: 1;
    }
    .tip {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
      margin-top: 12px;
    }
    .tips-section {
      margin-top: 12px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .tips-section .tip-item {
      font-size: 11px;
      color: #cbd5e1;
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .tips-section .tip-item:last-child {
      margin-bottom: 0;
    }
    .dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 16px;
    }
    .dialog {
      width: 100%;
      max-width: 420px;
      background: #0f172a;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }
    .dialog-header {
      padding: 14px 16px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .dialog-title {
      font-size: 15px;
      font-weight: 700;
    }
    .dialog-close {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.6);
      border-radius: 50%;
      color: #fca5a5;
      font-size: 24px;
      font-weight: 700;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
    }
    .dialog-close:hover {
      background: rgba(239, 68, 68, 0.4);
      border-color: rgba(239, 68, 68, 0.8);
      color: #f87171;
      transform: scale(1.1);
    }
    .dialog-body {
      padding: 10px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
      position: relative;
      order: 2;
    }
    .dialog-recommend {
      padding: 8px 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.95);
      flex-shrink: 0;
      order: 3;
      position: relative;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .recommend-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: #fbbf24;
    }
    .quota-hint {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
    }
    .quota-hint.exceeded {
      color: #f87171;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      width: 33%;
      text-align: center;
      margin: 0 auto;
    }
    .progress-container {
      width: 100%;
      margin-top: 8px;
    }
    .progress-bar {
      height: 8px;
      background: linear-gradient(90deg, #fbbf24, #fb923c);
      border-radius: 4px;
      transition: width 0.3s ease;
      margin-bottom: 6px;
    }
    .progress-text {
      font-size: 11px;
      color: #cbd5e1;
      text-align: center;
    }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-message {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .chat-message.placeholder {
      background: transparent;
      border: none;
      padding: 10px 0;
      text-align: center;
      color: #9ca3af;
    }
    .chat-message.user {
      align-self: flex-end;
      background: rgba(59, 130, 246, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }
    .chat-message .msg-label {
      font-weight: 700;
      font-size: 11px;
      color: #fbbf24;
    }
    .chat-message img {
      width: 100%;
      border-radius: 10px;
      object-fit: cover;
      -webkit-touch-callout: default;
      user-select: none;
    }
    .chat-message .save-hint {
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
      margin-top: 4px;
    }
    .chat-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chat-actions .btn {
      padding: 6px 10px;
      min-height: auto;
      border-radius: 10px;
      font-size: 11px;
    }
    .dialog-input {
      padding: 10px 16px 14px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      order: 4;
      flex-shrink: 0;
    }
    .upload-btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .upload-btn:hover {
      background: rgba(148, 163, 184, 0.15);
      border-color: rgba(248, 250, 252, 0.4);
    }
    .dialog-input textarea {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(2, 6, 23, 0.8);
      color: #fff;
      padding: 10px 12px;
      font-size: 12px;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
      font-family: inherit;
      line-height: 1.5;
    }
    .dialog-input button.send {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      background: linear-gradient(135deg, #facc15, #fb923c);
      color: #0f172a;
      cursor: pointer;
    }
    .dialog-input button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .upload-preview {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    @media (max-width: 380px) {
      .actions-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .btn {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      {% if is_logged_in %}
      <div class="login-status logged-in">
        <span>已登录：</span>
        <span class="login-name">{{ user_name }}</span>
      </div>
      {% else %}
      <div class="login-status">
        <span>未登录</span>
      </div>
      {% endif %}
      <div class="title">11 月财神赐福狂欢季！</div>
      <div class="subtitle"><span class="money">3 元</span>起领红包，<span class="money">50 元</span>大额奖，多多参与可拿<span class="money">100元</span>以上红包</div>
    </div>

    <div class="guide-section">
      <div class="guide-title">活动速通指南</div>
      <div class="step">
        <div class="step-number">①</div>
        <div class="step-content">
          <strong>入群即赚：</strong>点击「财神卡抽取」，解锁初始财神卡，再点击「生成财神手办」，每收集到1张全新财神卡并生成，可得<span class="money">3元</span>红包。
        </div>
      </div>
      <div class="step">
        <div class="step-number">②</div>
        <div class="step-content">
          <strong>集卡加码：</strong>攒 5 张不同财神卡并生成，解锁 <span class="money">50 元</span>大额红包。
        </div>
      </div>
      <div class="step">
        <div class="step-number">③</div>
        <div class="step-content">
          <strong>邀友共赢：</strong>邀请公司内部员工入群，点击「邀请好友登记」，你的好友生成后，你得抽卡次数（好友已入其他战队无效）。
        </div>
      </div>
      <div class="step">
        <div class="step-number">④</div>
        <div class="step-content">
          <strong>战队 PK：</strong>以战队累计总财神卡数量进行排名，战队第 1 名瓜分<span class="money">1000元</span>、第 2 名 瓜分<span class="money">500元</span>、第 3 名 瓜分<span class="money">100元</span>，若每日排名对比前一日前进 1 名，当日群内每人可瓜分<span class="money">50元</span>。
        </div>
      </div>
    </div>

    <div class="actions-wrapper">
      <div class="actions-row">
        <a href="#" class="btn btn-primary" id="drawCardBtn">
          财神卡抽取
        </a>
        <button class="btn btn-secondary" id="openGenerator">
          生成财神手办
        </button>
        <a href="#" class="btn btn-tertiary" id="inviteFriendBtn">
          邀请好友登记
        </a>
      </div>
      <div class="gallery-section" id="gallerySection">
        <div class="gallery-header">
          <span>玩家生成展示</span>
          <span style="font-size:11px;">3 秒自动轮播</span>
        </div>
        <div class="gallery-track" id="galleryTrack"></div>
      </div>
    </div>

    <div class="tips-section">
      <div class="tip-item">1、每日审核1-2次刷新财神卡次数，当天会进行一次红包下发</div>
      <div class="tip-item">2、登记的好友同时在多个群，不计算战队成绩内，请提前确认好友是否加入其他战队（抢人大战）</div>
      <div class="tip-item">3、入群后请修改群内名称，同钉钉群内名称一致，便于红包下发</div>
      <div class="tip-item">4、每个人生成5次财神即可，比如抽中东路财神，就生成东路财神形象，重复的财神生成无用</div>
      <div class="tip-item">5、活动截止时间11月24日17点，统计战队排名（财神卡总数）并下发红包</div>
    </div>
  </div>

  <div class="dialog-overlay" id="generatorDialog">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title">生成财神手办</div>
        <button class="dialog-close" id="dialogClose">×</button>
      </div>
      <div class="dialog-body">
        <div class="chat-area" id="chatMessages"></div>
      </div>
      <div class="dialog-recommend">
        <button class="recommend-btn" id="usePrompt">使用推荐口令</button>
        <div class="quota-hint" id="quotaHint">每天有5次生成机会哦！</div>
      </div>
      <div class="dialog-input">
        <label class="upload-btn" id="uploadTrigger">上传图片</label>
        <div class="upload-preview" id="uploadPreview" style="display:none;"></div>
        <input type="file" accept="image/*" id="uploadInput" hidden />
        <textarea id="promptInput" placeholder="输入你的口令或使用推荐口令" rows="1"></textarea>
        <button class="send" id="sendBtn">生成</button>
      </div>
    </div>
  </div>

  <script type="application/json" id="initialGalleryData">{{ approved_gallery_data|tojson|safe }}</script>

  <script>
    /* eslint-disable */
    const initialGalleryEl = document.getElementById("initialGalleryData");
    const initialGallery = initialGalleryEl ? JSON.parse(initialGalleryEl.textContent || "[]") : [];
    const openGeneratorBtn = document.getElementById("openGenerator");
    const dialogOverlay = document.getElementById("generatorDialog");
    const dialogClose = document.getElementById("dialogClose");
    const usePromptBtn = document.getElementById("usePrompt");
    const uploadInput = document.getElementById("uploadInput");
    const uploadTrigger = document.getElementById("uploadTrigger");
    const uploadPreview = document.getElementById("uploadPreview");
    const promptInput = document.getElementById("promptInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatMessages = document.getElementById("chatMessages");
    const gallerySection = document.getElementById("gallerySection");
    const galleryTrack = document.getElementById("galleryTrack");
    const drawCardBtn = document.getElementById("drawCardBtn");
    const inviteFriendBtn = document.getElementById("inviteFriendBtn");
    const quotaHint = document.getElementById("quotaHint");

    // 登录状态（从后端传递）
    const isLoggedIn = {{ 'true' if is_logged_in else 'false' }};
    
    // 获取生成配额（仅用于检查是否用完，不显示动态次数）
    async function updateQuota() {
      if (!isLoggedIn) {
        quotaHint.textContent = "每天有5次生成机会哦！";
        return;
      }
      try {
        const resp = await fetch("/api/generate-quota");
        const data = await resp.json();
        if (data.success) {
          const remaining = data.remaining;
          if (remaining > 0) {
            quotaHint.textContent = "每天有5次生成机会哦！";
            quotaHint.className = "quota-hint";
          } else {
            quotaHint.textContent = "您今天的生成额度已用完，明天再来！";
            quotaHint.className = "quota-hint exceeded";
            sendBtn.disabled = true;
            sendBtn.style.opacity = "0.6";
            sendBtn.style.cursor = "not-allowed";
          }
        }
      } catch (error) {
        console.error("获取配额失败:", error);
        quotaHint.textContent = "每天有5次生成机会哦！";
      }
    }
    
    // 页面加载时获取配额
    if (isLoggedIn) {
      updateQuota();
    }

    const RECOMMENDED_PROMPT = "帮我生成图片：用这张图片的脸生成一张Q版财神手办，材质为：黏土或羊毛毡或毛线，随机。财神穿汉服，戴帽子，可以有胡子，形象可以参考五路财神（比干、柴荣、关羽、赵公明、王亥，随机）。整体是喜庆风格，暖色调，背景有一些新年元素。有立体感，有光泽度，手办为全身完整，且有底座，手办的脸部特征要和原图的脸部高度相似，性别相同。一张正方形比例图片。";

    let selectedFile = null;
    let lastFile = null;
    let lastPrompt = "";
    let lastPreviewUrl = "";
    let galleryImages = [];
    let galleryIndex = 0;
    let galleryTimer = null;

    // 检查登录状态，未登录则跳转到登录页
    function checkLoginAndRedirect(targetUrl, action) {
      if (!isLoggedIn) {
        // 未登录，跳转到登录页，并保存目标页面
        const loginUrl = `/login?next=${encodeURIComponent(targetUrl)}`;
        window.location.href = loginUrl;
        return false;
      }
      return true;
    }

    function openDialog() {
      // 检查登录状态
      if (!checkLoginAndRedirect(window.location.href, "生成财神手办")) {
        return;
      }
      dialogOverlay.style.display = "flex";
      document.body.style.overflow = "hidden";
      
      // 恢复聊天记录
      const hasHistory = chatMessages.querySelectorAll(".chat-message:not(.placeholder)").length > 0;
      if (!hasHistory) {
        restoreChatHistory();
      }
      if (chatMessages.querySelectorAll(".chat-message").length === 0) {
        ensureChatPlaceholder();
      }
      
      updateQuota().then(() => {
        validateSendButton();
      });
    }
    function closeDialog() {
      dialogOverlay.style.display = "none";
      document.body.style.overflow = "";
    }
    openGeneratorBtn.addEventListener("click", openDialog);
    
    // 财神卡抽取按钮
    drawCardBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const targetUrl = "/draw";
      if (checkLoginAndRedirect(targetUrl, "财神卡抽取")) {
        window.location.href = targetUrl;
      }
    });
    
    // 邀请好友登记按钮
    inviteFriendBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const targetUrl = "https://v.wjx.cn/vm/OPVi0CD.aspx#";
      if (checkLoginAndRedirect(targetUrl, "邀请好友登记")) {
        window.open(targetUrl, "_blank");
      }
    });
    dialogClose.addEventListener("click", closeDialog);
    dialogOverlay.addEventListener("click", (e) => {
      if (e.target === dialogOverlay) closeDialog();
    });

    function autoResizeTextarea() {
      promptInput.style.height = "auto";
      promptInput.style.height = Math.min(promptInput.scrollHeight, 120) + "px";
    }

    usePromptBtn.addEventListener("click", () => {
      promptInput.value = RECOMMENDED_PROMPT;
      autoResizeTextarea();
      validateSendButton();
    });

    uploadTrigger.addEventListener("click", () => uploadInput.click());
    uploadInput.addEventListener("change", () => {
      if (uploadInput.files && uploadInput.files[0]) {
        selectedFile = uploadInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadPreview.style.display = "block";
          uploadPreview.style.backgroundImage = `url(${e.target.result})`;
          lastPreviewUrl = e.target.result;
        };
        reader.readAsDataURL(selectedFile);
      }
      validateSendButton();
    });

    async function validateSendButton() {
      // 按钮始终可点击，不再根据输入状态禁用
      // 只在配额用完时禁用
      if (isLoggedIn && quotaHint) {
        const quotaHintText = quotaHint.textContent;
        const hasQuota = !quotaHintText.includes("已用完");
        if (!hasQuota) {
          sendBtn.disabled = true;
          sendBtn.style.opacity = "0.6";
          sendBtn.style.cursor = "not-allowed";
        } else {
          sendBtn.disabled = false;
          sendBtn.style.opacity = "1";
          sendBtn.style.cursor = "pointer";
        }
      } else {
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
        sendBtn.style.cursor = "pointer";
      }
    }
    promptInput.addEventListener("input", () => {
      autoResizeTextarea();
      validateSendButton();
    });

    // 保存聊天记录到localStorage
    function saveChatHistory() {
      const messages = [];
      chatMessages.querySelectorAll(".chat-message:not(.placeholder)").forEach((msgEl) => {
        const msgData = {
          type: msgEl.className.includes("user") ? "user" : 
                msgEl.className.includes("ai") ? "ai" : "system",
          label: msgEl.querySelector(".msg-label")?.textContent || "",
          text: msgEl.querySelector("div:not(.msg-label):not(.save-hint)")?.textContent || "",
          imageUrl: msgEl.querySelector("img")?.src || "",
          showSaveHint: !!msgEl.querySelector(".save-hint"),
        };
        messages.push(msgData);
      });
      localStorage.setItem("generate_chat_history", JSON.stringify(messages));
    }
    
    // 恢复聊天记录
    function restoreChatHistory() {
      try {
        const saved = localStorage.getItem("generate_chat_history");
        if (saved) {
          const messages = JSON.parse(saved);
          messages.forEach((msgData) => {
            appendMessage(msgData, false); // false表示不保存到localStorage（避免重复）
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      } catch (error) {
        console.error("恢复聊天记录失败:", error);
      }
    }

    function appendMessage({ type, label, text, imageUrl, actions, showSaveHint }, saveToStorage = true) {
      const msg = document.createElement("div");
      msg.className = `chat-message ${type}`;
      if (label) {
        const lbl = document.createElement("div");
        lbl.className = "msg-label";
        lbl.textContent = label;
        msg.appendChild(lbl);
      }
      if (text) {
        const p = document.createElement("div");
        p.textContent = text;
        msg.appendChild(p);
      }
      if (imageUrl) {
        const img = document.createElement("img");
        img.src = imageUrl;
        msg.appendChild(img);
        if (showSaveHint) {
          const hint = document.createElement("div");
          hint.className = "save-hint";
          hint.textContent = "长按图片保存";
          msg.appendChild(hint);
        }
      }
      if (actions && actions.length) {
        const actionWrap = document.createElement("div");
        actionWrap.className = "chat-actions";
        actions.forEach((act) => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = act.label;
          btn.addEventListener("click", act.onClick);
          actionWrap.appendChild(btn);
        });
        msg.appendChild(actionWrap);
      }
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // 保存到localStorage（排除进度条消息）
      if (saveToStorage && !msg.querySelector(".progress-container")) {
        saveChatHistory();
      }
      
      return msg;
    }

    function startProgress(messageEl) {
      // 创建进度条容器
      const progressContainer = document.createElement("div");
      progressContainer.className = "progress-container";
      
      const progressBar = document.createElement("div");
      progressBar.className = "progress-bar";
      progressBar.style.width = "0%";
      
      const progressText = document.createElement("div");
      progressText.className = "progress-text";
      progressText.textContent = "生成中0%，免费服务器，请耐心等待";
      
      progressContainer.appendChild(progressBar);
      progressContainer.appendChild(progressText);
      messageEl.innerHTML = "";
      messageEl.appendChild(progressContainer);
      
      let currentProgress = 0;
      let timer = null;
      
      // 91%之前快速加载
      function fastProgress() {
        if (currentProgress >= 91) {
          slowProgress();
          return;
        }
        currentProgress += Math.random() * 15 + 5; // 5-20% 随机增长
        if (currentProgress > 91) currentProgress = 91;
        
        progressBar.style.width = currentProgress + "%";
        progressText.textContent = `生成中${Math.floor(currentProgress)}%，免费服务器，请耐心等待`;
        
        timer = setTimeout(fastProgress, 200 + Math.random() * 300); // 200-500ms随机延迟
      }
      
      // 91%之后缓慢增加到100%
      function slowProgress() {
        if (currentProgress >= 100) return;
        currentProgress += Math.random() * 2 + 0.5; // 0.5-2.5% 缓慢增长
        if (currentProgress > 100) currentProgress = 100;
        
        progressBar.style.width = currentProgress + "%";
        progressText.textContent = `生成中${Math.floor(currentProgress)}%，免费服务器，请耐心等待`;
        
        timer = setTimeout(slowProgress, 500 + Math.random() * 500); // 500-1000ms随机延迟
      }
      
      fastProgress();

      return {
        finish(success = true) {
          if (timer) clearTimeout(timer);
          if (success) {
            currentProgress = 100;
            progressBar.style.width = "100%";
            progressText.textContent = "生成完成！";
          } else {
            progressText.textContent = "生成失败，请稍后重试。";
          }
        },
      };
    }

    function ensureChatPlaceholder() {
      if (!chatMessages.querySelector(".placeholder")) {
        const placeholder = document.createElement("div");
        placeholder.className = "chat-message placeholder";
        placeholder.textContent = "上传你的图片，开始生成你的财神形象吧";
        chatMessages.appendChild(placeholder);
      }
    }

    function clearPlaceholder() {
      const placeholder = chatMessages.querySelector(".placeholder");
      if (placeholder) placeholder.remove();
    }

    function resetGenerateInputs() {
      selectedFile = null;
      uploadInput.value = "";
      uploadPreview.style.display = "none";
      uploadPreview.style.backgroundImage = "";
      promptInput.value = "";
      autoResizeTextarea();
      validateSendButton();
    }

    // 初始化时不显示placeholder，等打开对话框时再恢复历史记录
    validateSendButton(); // 初始化按钮状态

    function getCurrentPreviewUrl() {
      let previewUrl = uploadPreview.style.backgroundImage || "";
      if (previewUrl.startsWith("url(")) {
        previewUrl = previewUrl.replace(/^url\(["']?/, "").replace(/["']?\)$/, "");
      } else {
        previewUrl = "";
      }
      if (!previewUrl && lastPreviewUrl) {
        previewUrl = lastPreviewUrl;
      }
      return previewUrl;
    }

    async function sendGenerate(isRetry = false) {
      const promptText = promptInput.value.trim() || lastPrompt;
      const fileToUse = selectedFile || lastFile;
      
      // 检查输入，根据实际情况提示
      if (!fileToUse && !promptText) {
        appendMessage({
          type: "system",
          label: "提示",
          text: "请上传图片，并输入口令提示词",
        });
        return;
      }
      
      if (!fileToUse) {
        appendMessage({
          type: "system",
          label: "提示",
          text: "请上传图片",
        });
        return;
      }
      
      if (!promptText) {
        appendMessage({
          type: "system",
          label: "提示",
          text: "请输入口令提示词",
        });
        return;
      }
      
      // 开始生成时暂时禁用按钮，防止重复点击
      sendBtn.disabled = true;
      sendBtn.style.opacity = "0.6";
      sendBtn.style.cursor = "not-allowed";

      clearPlaceholder();

      const previewUrl = getCurrentPreviewUrl();

      appendMessage({
        type: "user",
        label: isRetry ? "重新生成" : "我的口令",
        text: promptText,
        imageUrl: previewUrl || lastPreviewUrl || null,
      });

      const statusMsg = appendMessage({
        type: "system",
        label: "系统",
        text: "",
      }, false); // 不保存进度条消息到历史记录
      const progress = startProgress(statusMsg);

      const formData = new FormData();
      formData.append("prompt", promptText);
      formData.append("image", fileToUse);

      // 创建AbortController用于超时控制
      const controller = new AbortController();
      const timeoutId = setTimeout(() => {
        controller.abort();
      }, 90000); // 90秒超时

      try {
        const resp = await fetch("/api/generate-figure", {
          method: "POST",
          body: formData,
          signal: controller.signal,
        });
        
        clearTimeout(timeoutId);
        const data = await resp.json();
        
        if (!resp.ok || !data.success) {
          progress.finish(false);
          if (data.error === "QUOTA_EXCEEDED") {
            appendMessage({
              type: "system",
              label: "提示",
              text: data.message || "您今天的生成额度已用完，明天再来！",
            });
            updateQuota();
          } else {
            // 根据错误类型显示不同的提示
            let errorMessage = "生成失败，请稍后重试。";
            if (data.error === "NETWORK_ERROR") {
              errorMessage = "网络连接异常，请检查网络后重试。";
            } else if (data.error === "TIMEOUT_ERROR") {
              errorMessage = "请求超时，请检查网络后重试。";
            } else if (data.error === "SERVER_ERROR") {
              errorMessage = "服务器繁忙，请稍后重试。";
            } else if (data.message) {
              errorMessage = data.message;
            }
            
            appendMessage({
              type: "system",
              label: "提示",
              text: errorMessage,
            });
          }
        } else {
          progress.finish(true);
          lastPrompt = promptText;
          lastFile = fileToUse;
          lastPreviewUrl = previewUrl;
          const resultMsg = appendMessage({
            type: "ai",
            label: "财神助手",
            text: "这是你的财神手办，长按图片保存！",
            imageUrl: data.dream_image_url || data.thumbnail_url,
            showSaveHint: true,
          });
          // 更新配额显示
          updateQuota();
          // 滚动到生成结果
          setTimeout(() => {
            resultMsg.scrollIntoView({ behavior: "smooth", block: "end" });
          }, 100);
        }
      } catch (error) {
        clearTimeout(timeoutId);
        console.error("生成请求失败:", error);
        progress.finish(false);
        
        // 根据错误类型显示不同的提示
        let errorMessage = "生成失败，请稍后重试。";
        if (error.name === "AbortError") {
          errorMessage = "请求超时，请检查网络后重试。";
        } else if (error.name === "TypeError" && error.message.includes("fetch")) {
          errorMessage = "网络连接异常，请检查网络后重试。";
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        appendMessage({
          type: "system",
          label: "提示",
          text: errorMessage,
        });
      } finally {
        resetGenerateInputs();
        // 恢复按钮状态（配额检查）
        validateSendButton();
      }
    }

    sendBtn.addEventListener("click", () => sendGenerate(false));

    function renderGallery(images) {
      galleryTrack.innerHTML = "";
      if (!images.length) {
        gallerySection.style.display = "none";
        return;
      }
      gallerySection.style.display = "flex";
      images.forEach((img, idx) => {
        const node = document.createElement("img");
        node.src = img.thumbnail_url;
        if (idx === 0) node.classList.add("active");
        galleryTrack.appendChild(node);
      });
      galleryImages = Array.from(galleryTrack.querySelectorAll("img"));
      galleryIndex = 0;
      if (galleryTimer) clearInterval(galleryTimer);
      if (galleryImages.length > 1) {
        galleryTimer = setInterval(() => {
          galleryImages[galleryIndex].classList.remove("active");
          galleryIndex = (galleryIndex + 1) % galleryImages.length;
          galleryImages[galleryIndex].classList.add("active");
        }, 3000);
      }
    }

    async function loadApprovedImages() {
      try {
        const resp = await fetch("/api/approved-generates?limit=3");
        const data = await resp.json();
        if (data.success && data.items && data.items.length > 0) {
          renderGallery(data.items);
        } else {
          gallerySection.style.display = "none";
        }
      } catch (error) {
        console.error("load gallery error", error);
        gallerySection.style.display = "none";
      }
    }

    if (initialGallery.length) {
      renderGallery(initialGallery.slice(0, 3));
    } else {
      loadApprovedImages();
    }
  </script>
</body>
</html>